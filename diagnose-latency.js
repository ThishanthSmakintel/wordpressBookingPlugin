// DIAGNOSE LATENCY - Find the bottleneck
(async()=>{console.log('🔍 Diagnosing latency...\n');const m=async(n,f)=>{const s=performance.now();try{const r=await f();const d=performance.now()-s;console.log(`${d<10?'🟢':d<50?'🟡':'🔴'} ${n}: ${d.toFixed(1)}ms`);return{d,r}}catch(e){console.log(`❌ ${n}: ${e.message}`);return{d:0,r:null}}};const a='/wp-json/appointease/v1';const c=`test_${Date.now()}`;console.log('1️⃣ Testing API Response Time...');const api=await m('API Call',async()=>await fetch(`${a}/slots/select`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({date:'2024-01-15',time:'09:00',employee_id:1,client_id:c})}));console.log('\n2️⃣ Testing Network Only...');const net=await m('Network (ping)',async()=>await fetch(`${a}/slots/select`,{method:'HEAD'}));console.log('\n3️⃣ Testing Redis Health...');const redis=await m('Redis Check',async()=>{const r=await fetch(`${a}/slots/select`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({date:'2024-01-15',time:'09:10',employee_id:1,client_id:c})});const j=await r.json();return j});console.log('\n4️⃣ Testing Database...');const db=await m('DB Query',async()=>await fetch('/wp-json/booking/v1/availability',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({date:'2024-01-15',employee_id:1})}));console.log('\n5️⃣ Testing Heartbeat...');const hb=await m('Heartbeat',()=>new Promise(r=>{if(typeof wp==='undefined'||!wp.heartbeat){console.log('⚠️ Heartbeat not available');r();return}const h=(e,d)=>{wp.heartbeat.off('tick',h);r()};wp.heartbeat.on('tick',h);wp.heartbeat.connectNow()}));console.log('\n📊 DIAGNOSIS:');if(api.d>100)console.log('🔴 API is slow (>100ms) - Check PHP/Redis/MySQL');else if(api.d>50)console.log('🟡 API is moderate (50-100ms) - Optimize queries');else console.log('🟢 API is fast (<50ms)');if(net.d>20)console.log('🔴 Network latency high (>20ms) - Check server/CDN');if(hb.d>500)console.log('🔴 Heartbeat slow (>500ms) - Reduce interval');console.log('\n💡 RECOMMENDATIONS:');if(api.d>50){console.log('• Check Redis: redis-cli ping');console.log('• Check MySQL indexes');console.log('• Enable PHP opcache');console.log('• Check error logs: wp-content/debug.log')}console.log('\n✅ Diagnosis complete');})();
